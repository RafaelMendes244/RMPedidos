{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>{{ tenant.name }} | Card√°pio Digital</title>

    {% if tenant.logo %}
    <link rel="icon" type="image/png" href="{{ tenant.logo.url }}">
    <link rel="apple-touch-icon" href="{{ tenant.logo.url }}">
    {% else %}
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    {% endif %}
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="{{ tenant.name }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="{{ tenant.name }}">

    <link rel="manifest" href="{% url 'pwa_manifest' tenant.slug %}?v={{ tenant.updated_at|date:'U' }}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <meta name="description" content="Card√°pio digital de {{ tenant.name }}. Pe√ßa pelo WhatsApp com entrega r√°pida.">
    <meta name="theme-color" content="{{ tenant.primary_color }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: {{ tenant.primary_color }};
            --accent: {{ tenant.primary_color }};
        }
        /* Ensure common orange utilities reflect tenant color */
        .text-orange-600 { color: var(--primary) !important; }
        .text-orange-500 { color: var(--primary) !important; }
        .text-orange-400 { color: var(--primary) !important; }
        .text-orange-300 { color: var(--primary) !important; }
        .text-orange-700 { color: var(--primary) !important; }
        .bg-orange-50 { background-color: rgba(0,0,0,0.03) !important; }
        .bg-orange-600 { background-color: var(--primary) !important; }
        .bg-orange-500 { background-color: var(--primary) !important; }
        .border-orange-100 { border-color: color-mix(in srgb, var(--primary) 20%, #fff) !important; }
        .border-orange-500 { border-color: var(--primary) !important; }
        .border-orange-600 { border-color: var(--primary) !important; }
        .hover\:text-orange-600:hover { color: var(--primary) !important; }
        .hover\:bg-orange-500:hover { background-color: var(--primary) !important; }
        .hover\:bg-orange-50:hover { background-color: rgba(0,0,0,0.03) !important; }
        .accent-orange-600 { accent-color: var(--primary) !important; }
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        
        /* Ensure buttons with primary background have readable text based on contrast */
        button[style*="background-color"],
        [style*="background-color"] { color: inherit !important; }
        .bg-primary { color: inherit !important; }
        [style*="--primary"] { color: inherit !important; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fef7ed;
            color: #451a03;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', serif; }
        
        /* Scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fed7aa; border-radius: 10px; }

        /* Bot√µes com cor prim√°ria - texto adaptativo */
        .btn-primary-contrast {
            color: #ffffff !important;
        }
        
        .btn-primary-contrast.adaptive-light-text {
            color: #ffffff !important;
        }
        
        .btn-primary-contrast.adaptive-dark-text {
            color: #1f2937 !important;
        }

        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .swal2-close { color: #451a03 !important; outline: none !important; box-shadow: none !important; transition: color 0.3s ease !important; }
        .swal2-close:hover { color: var(--primary) !important; background: transparent !important; }

        /* ============================================
           ESTILOS PARA BOT√ïES DE CATEGORIA
           ============================================ */
        .category-btn {
            cursor: pointer;
            border: 2px solid transparent;
        }

        .category-btn.active-category {
            border-color: transparent;
        }

        .category-btn:not(.active-category):hover {
            transform: scale(1.05);
        }

        .category-section {
            transition: opacity 0.3s ease;
        }

        .category-section:hidden {
            display: none !important;
        }
    </style>
</head>

<body class="pb-32 antialiased selection:bg-blue-300 selection:text-gray-900">
    <header id="main-header" class="relative w-full h-[500px] md:h-[600px] flex flex-col items-center justify-center text-center text-white overflow-hidden shadow-2xl">
        <div id="header-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-[3000ms] transform hover:scale-105"
            style="background-image: url('{% if tenant.background_image %}{{ tenant.background_image.url }}{% else %}https://blog.connectplug.com.br/wp-content/uploads/2024/06/4016-1-e1718285827136.jpg{% endif %}');">
        </div>
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
        <div class="absolute inset-0 opacity-40 mix-blend-multiply" style="background-color: {{ tenant.primary_color }};"></div>

        <div class="relative z-10 px-6 w-full max-w-4xl mx-auto flex flex-col items-center animate-fadeIn">
            {% if tenant.logo %}
                <img src="{{ tenant.logo.url }}" class="w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-white/20 shadow-xl mb-6 object-cover">
            {% endif %}

            <h1 class="text-5xl md:text-7xl font-serif font-medium tracking-wider drop-shadow-xl text-white uppercase mb-4">
                {{ tenant.name }}
            </h1>

            <p class="text-sm md:text-lg font-light opacity-90 mb-8 max-w-lg leading-relaxed text-orange-100 font-sans">
                Fa√ßa seu pedido online. Entrega r√°pida e segura.
            </p>

            <div id="status-loja-container" class="inline-flex items-center gap-3 px-5 py-2.5 rounded-full bg-black/40 backdrop-blur-md border border-white/10 text-xs font-bold shadow-lg mb-6 transition hover:bg-black/50">
                <i id="status-icon" class="fas fa-circle text-[8px] animate-pulse text-green-400"></i>
                <span id="status-text" class="tracking-widest uppercase">LOJA ONLINE</span>
            </div>

            <!-- Tempo de Entrega e Retirada -->
            <div class="flex flex-wrap justify-center gap-3 mb-6">
                {% if tenant.show_delivery_time %}
                <div class="flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full">
                    <i class="fas fa-motorcycle text-white"></i>
                    <span class="text-xs font-bold text-white">
                        Entrega: {{ tenant.delivery_time }}min
                    </span>
                </div>
                {% endif %}
                {% if tenant.show_pickup_time %}
                <div class="flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full">
                    <i class="fas fa-walking text-white"></i>
                    <span class="text-xs font-bold text-white">
                        Retirada: {{ tenant.pickup_time }}min
                    </span>
                </div>
                {% endif %}
            </div>

            <a href="#menu-items" class="px-8 py-3 bg-white text-gray-900 rounded-full font-bold uppercase text-xs tracking-widest hover:bg-gray-100 transition shadow-lg">
                Ver Card√°pio
            </a>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 -mt-8 relative z-20 grid grid-cols-2 gap-4 max-w-sm sm:max-w-md">
        <button onclick="openStoreInfo()" class="bg-white dark:bg-gray-800 text-gray-800 dark:text-white py-4 rounded-2xl shadow-xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:-translate-y-1 transition border border-orange-100 dark:border-gray-700">
            <i class="fas fa-store" style="color: {{ tenant.primary_color }}"></i> Info & Local
        </button>
        <button 
            onclick="openHistory()" 
            class="adaptive-text-contrast py-4 rounded-2xl shadow-xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:-translate-y-1 transition"
            style="background-color: {{ tenant.primary_color }};">
            <i class="fas fa-history"></i>
            <span class="btn-text">Meus Pedidos</span>
        </button>
    </div>

    <nav class="sticky top-0 z-40 bg-[#fef7ed]/95 dark:bg-gray-900/95 backdrop-blur-md border-b border-orange-100 dark:border-gray-800 py-4 mb-8 shadow-sm transition-all duration-300" id="category-nav">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between mb-4 md:hidden">
                <h2 class="font-serif text-xl text-gray-800 dark:text-white italic">Card√°pio</h2>
                <span id="mobile-status-text" class="text-xs font-bold text-gray-400">
                    Carregando...
                </span>
            </div>

            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1" id="category-filters">
                <button onclick="filterCategory('all', this)" class="category-btn px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 flex-shrink-0 bg-gray-900 text-white shadow-lg transform hover:scale-105 active:scale-95 dark:bg-white dark:text-gray-900 active-category">
                    <i class="fas fa-th-large mr-1"></i> Todos
                </button>
                
                {% for category in categories %}
                <button onclick="filterCategory('cat-{{ category.id }}', this)" class="category-btn px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 border flex-shrink-0 bg-white text-gray-600 border-gray-200 hover:border-orange-500 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700">
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 min-h-[400px]" id="menu-items">
        
        {% for category in categories %}
            <div id="cat-{{ category.id }}" class="category-section">
                <div class="flex items-center gap-4 mt-8 mb-6 w-full animate-fadeIn pt-4">
                    <span class="h-px w-8" style="background-color: {{ tenant.primary_color }}"></span>
                    <h2 class="text-3xl font-serif text-gray-800 dark:text-white capitalize italic tracking-wide">
                        {{ category.name }}
                    </h2>
                    <span class="h-px flex-1 bg-gray-200 dark:bg-gray-700"></span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                {% for product in category.products.all %}
                <div class="group relative bg-white dark:bg-gray-800 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgb(234,88,12,0.15)] transition-all duration-300 border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col h-full hover:-translate-y-1">
    
                    <div class="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-pointer" onclick="showProductModal('{{ product.id }}')">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
                        {% else %}
                            <div class="h-full w-full flex items-center justify-center bg-orange-50">
                                <i class="fas fa-utensils text-4xl text-orange-200"></i>
                            </div>
                        {% endif %}

                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                        {% if product.badge %}
                        <span class="absolute top-3 left-3 bg-red-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-lg z-20 shadow-lg uppercase tracking-wider backdrop-blur-sm bg-opacity-90">
                            {{ product.badge }}
                        </span>
                        {% endif %}

                        <button onclick="event.stopPropagation(); toggleFavorite('{{ product.id }}')" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/90 dark:bg-gray-800/90 backdrop-blur flex items-center justify-center text-gray-400 hover:text-red-500 transition shadow-sm z-20 active:scale-90">
                            <i class="far fa-heart text-sm"></i>
                        </button>
                    </div>

                    <div class="p-5 flex flex-col flex-1 justify-between">
                        <div class="cursor-pointer" onclick="showProductModal('{{ product.id }}')">
                            <div class="flex justify-between items-start gap-2 mb-2">
                                <h3 class="text-base font-bold text-gray-800 dark:text-gray-100 leading-tight group-hover:text-orange-600 transition-colors">
                                    {{ product.name }}
                                </h3>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 leading-relaxed mb-4">
                                {{ product.description|default:"Toque para ver detalhes e ingredientes." }}
                            </p>
                        </div>
                        
                        <div class="flex items-end justify-between mt-auto pt-4 border-t border-gray-50 dark:border-gray-700">
                            <div class="flex flex-col">
                                {% if product.original_price %}
                                    <span class="text-[10px] text-gray-400 line-through mb-0.5">R$ {{ product.original_price }}</span>
                                {% endif %}
                                <span class="text-lg font-bold text-gray-900 dark:text-white font-serif tracking-tight">
                                    R$ {{ product.price }}
                                </span>
                            </div>
                            
                            <button 
                                onclick="showProductModal('{{ product.id }}')"
                                class="relative overflow-hidden bg-orange-600 text-white px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-orange-700 transition shadow-lg shadow-orange-600/20 active:scale-95 group/btn"
                                style="background-color: {{ tenant.primary_color }}">
                                <span class="relative z-10 flex items-center gap-2">
                                    Adicionar <i class="fas fa-plus"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>
        {% endfor %}

        {% if not categories %}
        <div class="text-center py-20 opacity-50 flex flex-col items-center">
            <i class="fas fa-utensils text-4xl mb-4 text-gray-300"></i>
            <p class="text-xl font-serif text-gray-500">Nenhum prato dispon√≠vel no momento.</p>
        </div>
        {% endif %}

    </main>

    <footer id="footer-cart" onclick="openCart()" class="fixed bottom-6 left-4 right-4 max-w-md mx-auto bg-orange-600/95 backdrop-blur-md text-white p-3 pr-5 rounded-full shadow-2xl cursor-pointer hidden flex items-center justify-between z-40 border border-orange-500 ring-1 ring-white/10" style="background-color: {{ tenant.primary_color }}">
        <div class="flex items-center gap-4">
            <div class="relative bg-white/10 w-12 h-12 rounded-full flex items-center justify-center border border-white/10">
                <i class="fas fa-shopping-bag text-lg text-white"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-md border border-white transition-transform scale-0">0</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[9px] text-white/80 uppercase font-bold tracking-widest">Total Estimado</span>
                <span id="cart-total-preview" class="font-serif text-lg text-white font-medium leading-none">R$ 0,00</span>
            </div>
        </div>
        <div class="flex items-center gap-2 text-[10px] font-bold bg-white text-orange-600 px-4 py-2 rounded-full shadow-lg uppercase tracking-widest" style="color: {{ tenant.primary_color }}">
            Ver Sacola <i class="fas fa-arrow-right ml-1"></i>
        </div>
    </footer>

    <div id="cart-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeCart()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-[450px] bg-white dark:bg-gray-900 shadow-2xl transform transition-transform duration-300 ease-out flex flex-col h-[100dvh]">
            
            <div class="p-6 flex justify-between items-center border-b dark:border-gray-800">
                <h2 class="text-xl font-serif dark:text-white">Sua Sacola</h2>
                <button onclick="closeCart()" class="dark:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex-1 p-5 overflow-y-auto" id="cart-content-area">
                
                <div id="step-1-cart">
                    <div id="cart-header" class="hidden flex justify-between items-end mb-4 px-1 border-b border-gray-100 dark:border-gray-800 pb-2">
                        <h3 class="font-bold text-gray-500 text-xs uppercase tracking-widest">Seus Itens</h3>
                        <button onclick="clearCart()" class="text-[10px] text-red-500 font-bold hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition uppercase flex items-center gap-1">
                            <i class="fas fa-trash-alt"></i> Esvaziar
                        </button>
                    </div>

                    <div id="cart-items" class="space-y-4"></div>

                    <div id="empty-cart-msg" class="hidden text-center py-24 flex flex-col items-center opacity-60">
                        <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-orange-300">
                            <i class="fas fa-utensils text-3xl"></i>
                        </div>
                        <p class="font-serif text-xl text-gray-600 dark:text-gray-400 italic mb-2">Sua sacola est√° vazia.</p>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Adicione nossos pratos deliciosos.</p>
                        <button onclick="closeCart()" class="mt-8 px-8 py-3 bg-orange-600 text-white rounded-full text-xs font-bold uppercase tracking-widest shadow-lg hover:bg-orange-700 transition">Ver Card√°pio</button>
                    </div>
                </div>

                <div id="step-2-address" class="hidden space-y-4 animate-fadeIn">
                    <button onclick="backToCart()" class="text-xs text-gray-500 font-bold mb-2"><i class="fas fa-arrow-left"></i> Voltar</button>
                    
                    <div class="space-y-3">
                        <input type="text" id="client-name" placeholder="Seu Nome" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white">
                        <input type="tel" id="client-phone" placeholder="Seu WhatsApp" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white">
                        
                        <div class="flex p-1 bg-gray-100 dark:bg-gray-700 rounded-xl">
                            <button id="btn-delivery" onclick="toggleDelivery(true)" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow text-orange-600">ENTREGA</button>
                            <button id="btn-pickup" onclick="toggleDelivery(false)" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500">RETIRADA</button>
                        </div>

                        {% if tenant.allow_scheduling %}
                        <div id="agendamento-container" class="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-100">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="is_scheduled" class="w-4 h-4 text-orange-600 rounded" onchange="document.getElementById('scheduling-fields').classList.toggle('hidden', !this.checked)">
                                <span class="text-sm font-bold text-orange-800">Agendar para outro dia?</span>
                            </label>

                            <div id="scheduling-fields" class="hidden mt-3 grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] font-bold text-orange-600 uppercase">Data</label>
                                    <input type="date" id="scheduled_date" class="w-full p-2 text-sm border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-orange-600 uppercase">Hora</label>
                                    <input type="time" id="scheduled_time" class="w-full p-2 text-sm border rounded-md">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div id="address-container" class="space-y-2">
                            <button type="button" onclick="usarLocalizacao()" id="btn-geo" class="w-full py-2 mb-2 flex items-center justify-center gap-2 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl text-xs font-bold uppercase hover:bg-blue-100 transition">
                                <i class="fas fa-location-arrow"></i> Usar minha localiza√ß√£o atual
                            </button>
                            <input type="tel" id="cep" placeholder="CEP" maxlength="9" inputmode="numeric" onblur="buscarCep()" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white" aria-label="Campo de CEP - Digite 8 d√≠gitos">
                            <input type="text" id="address" placeholder="Rua" readonly class="w-full p-3 border rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white" aria-label="Campo de rua">
                            <div class="flex gap-2">
                                <input type="text" id="number" placeholder="N¬∫" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white" aria-label="Campo de n√∫mero">
                                <input type="text" id="neighborhood" placeholder="Bairro" readonly class="w-full p-3 border rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white" aria-label="Campo de bairro">
                            </div>
                            <p onclick="habilitarEnderecoManual()" class="text-[10px] text-orange-600 font-bold cursor-pointer text-right">Digitar endere√ßo manualmente</p>
                        </div>

                        <!-- Cupom de Desconto -->
                        <div class="bg-orange-50 dark:bg-gray-800 p-3 rounded-xl border border-orange-200 dark:border-gray-700">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-tag text-orange-500"></i>
                                <span class="text-xs font-bold uppercase text-orange-600 dark:text-orange-400">Cupom de Desconto</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="coupon-code" placeholder="C√≥digo do cupom" class="flex-1 p-2 border rounded-lg text-sm bg-white dark:bg-gray-900 dark:text-white uppercase" onkeyup="this.value = this.value.toUpperCase()">
                                <button onclick="applyCoupon()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-orange-600 transition">
                                    Aplicar
                                </button>
                            </div>
                            <div id="coupon-message" class="text-xs mt-2 hidden"></div>
                            <div id="coupon-applied" class="hidden mt-2 flex items-center justify-between bg-green-100 dark:bg-green-900 p-2 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-check-circle text-green-500"></i>
                                    <span class="text-xs font-bold text-green-700 dark:text-green-400" id="coupon-applied-code"></span>
                                </div>
                                <button onclick="removeCoupon()" class="text-xs text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <p class="text-xs font-bold uppercase text-gray-400">Forma de Pagamento</p>
                            
                            <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer bg-white dark:bg-gray-800 hover:bg-orange-50 transition" onclick="toggleTroco(false)">
                                <input type="radio" name="payment-method" value="pix" class="accent-orange-600" checked>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-qrcode text-orange-500"></i>
                                    <span class="text-sm font-bold dark:text-white">PIX (Autom√°tico)</span>
                                </div>
                            </label>

                            <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer bg-white dark:bg-gray-800 hover:bg-orange-50 transition" onclick="toggleTroco(false)">
                                <input type="radio" name="payment-method" value="cartao" class="accent-orange-600">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-credit-card text-blue-500"></i>
                                    <span class="text-sm font-bold dark:text-white">Cart√£o (Maquininha)</span>
                                </div>
                            </label>

                            <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer bg-white dark:bg-gray-800 hover:bg-orange-50 transition" onclick="toggleTroco(true)">
                                <input type="radio" name="payment-method" value="dinheiro" class="accent-orange-600">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-money-bill-wave text-green-500"></i>
                                    <span class="text-sm font-bold dark:text-white">Dinheiro</span>
                                </div>
                            </label>

                            <div id="troco-container" class="hidden animate-fadeIn ml-2 border-l-2 border-orange-200 pl-4 mt-2">
                                <label class="text-xs font-bold text-gray-500 block mb-1">Precisa de troco para quanto?</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 font-bold">R$</span>
                                    <input type="number" id="troco-valor" placeholder="Ex: 50.00" class="w-full p-2 border rounded-lg bg-white outline-none focus:border-orange-500">
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1">Deixe em branco se tiver o valor trocado.</p>
                            </div>
                        </div>
                        
                        <textarea style="resize: none;" id="order-notes" placeholder="Observa√ß√µes..." class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white"></textarea>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t dark:border-gray-800 bg-white dark:bg-gray-900">
                <!-- Resumo do Pedido -->
                <div id="order-summary" class="space-y-1 mb-4 hidden">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-xs font-bold text-gray-400">Subtotal</span>
                        <span id="cart-subtotal" class="text-sm font-medium text-gray-600 dark:text-gray-300">R$ 0,00</span>
                    </div>
                    <div id="delivery-fee-row" class="flex justify-between items-center text-sm hidden">
                        <span class="text-xs font-bold text-gray-400">Taxa de Entrega</span>
                        <span id="cart-delivery-fee" class="text-sm font-medium text-gray-600 dark:text-gray-300">R$ 0,00</span>
                    </div>
                    <div id="discount-summary-row" class="hidden flex justify-between items-center text-sm">
                        <span class="text-xs font-bold text-green-600">Desconto</span>
                        <span id="discount-amount-summary" class="text-sm font-bold text-green-600">-R$ 0,00</span>
                    </div>
                </div>

                <!-- Total Original (se houver desconto) -->
                <div id="discount-display" class="hidden flex justify-between items-end mb-1">
                    <span class="text-xs font-bold text-green-600">Desconto aplicado</span>
                    <span id="discount-amount" class="text-sm font-bold text-green-600">-R$ 0,00</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-xs font-bold text-gray-400">Total</span>
                    <span id="cart-total-final" class="text-2xl font-serif font-bold dark:text-white">R$ 0,00</span>
                </div>
                
                <button id="btn-next-step" onclick="goToAddress()" 
                    class="w-full py-3 text-white font-bold rounded-xl transition shadow-lg 
                    {% if not store_is_open %}bg-gray-400 cursor-not-allowed{% else %}bg-orange-600 hover:bg-orange-700{% endif %}" 
                    {% if not store_is_open %}disabled{% endif %}>
                    {% if not store_is_open %}Loja Fechada{% else %}Continuar{% endif %}
                </button>

                <button id="btn-finalize" onclick="finalizeOrder()" 
                    class="hidden w-full py-3 text-white font-bold rounded-xl transition shadow-lg 
                    {% if not store_is_open %}bg-gray-400 cursor-not-allowed{% else %}bg-green-600 hover:bg-green-700{% endif %}" 
                    {% if not store_is_open %}disabled{% endif %}>
                    {% if not store_is_open %}Loja Fechada{% else %}Finalizar Pedido no WhatsApp{% endif %}
                </button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px] transition-opacity" onclick="closeHistory()"></div>
        
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            
            <div class="bg-white dark:bg-gray-900 w-full md:w-[400px] h-[85vh] md:h-auto md:max-h-[600px] md:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-0 animate-fadeIn">
                
                <div class="p-6 flex justify-between items-center border-b border-gray-100 dark:border-gray-800 shrink-0">
                    <h2 class="text-xl font-serif font-bold text-gray-800 dark:text-white">Meus Pedidos</h2>
                    <button onclick="closeHistory()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-950 p-4 space-y-4" id="history-content">
                    <div class="text-center py-20 opacity-50 flex flex-col items-center">
                        <i class="fas fa-spinner fa-spin text-2xl text-orange-500"></i>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <div id="store-info-modal" onclick="if(event.target === this) window.closeStoreInfo()" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-3xl p-6 relative">
            <button onclick="closeStoreInfo()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-serif font-bold mb-4 dark:text-white">Informa√ß√µes</h2>
            
            <div class="space-y-4">
                <div>
                    <p class="text-xs font-bold text-orange-600 uppercase">Endere√ßo</p>
                    {% if tenant.address %}
                    <a href="https://www.google.com/maps/search/?api=1&query={{ tenant.address|urlencode }}" target="_blank" class="text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 transition flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="underline">{{ tenant.address }}</span>
                        <i class="fas fa-external-link-alt text-xs opacity-60"></i>
                    </a>
                    {% else %}
                    <p class="text-sm text-gray-400 italic">Endere√ßo n√£o cadastrado</p>
                    {% endif %}
                </div>
                
                <div class="mt-4">
                    <p class="text-xs font-bold text-orange-600 uppercase mb-2">Hor√°rios de Funcionamento</p>
                    <div id="info-horario" class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                        {% for day in operating_days %}
                            <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-1 last:border-0">
                                <span class="font-medium">{{ day.get_day_display }}</span>
                                <span>
                                    {% if day.is_closed %}
                                        <span class="text-red-500 font-bold text-xs">Fechado</span>
                                    {% else %}
                                        {{ day.open_time|date:"H:i" }} - {{ day.close_time|date:"H:i" }}
                                    {% endif %}
                                </span>
                            </div>
                        {% empty %}
                            <p class="italic text-gray-400 text-xs">Hor√°rios n√£o configurados pelo estabelecimento.</p>
                        {% endfor %}
                    </div>
                </div>
                </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>

        window.API_URL = "{% url 'api_create_order' tenant.slug %}";
        window.CSRF_TOKEN = "{{ csrf_token }}";
        window.TENANT_SLUG = "{{ tenant.slug }}";

        // ============================================
        // CONTRASTE AUTOM√ÅTICO PARA BOT√ïES
        // ============================================
        
        /**
         * Calcula a luminosidade relativa de uma cor (0-1)
         * Retorna true se a cor for escura (precisa de texto branco)
         * Retorna false se a cor for clara (precisa de texto preto)
         */
        function isColorDark(hexColor) {
            // Remove o # se existir
            hexColor = hexColor.replace('#', '');
            
            // Converte para RGB
            let r, g, b;
            if (hexColor.length === 3) {
                r = parseInt(hexColor[0] + hexColor[0], 16);
                g = parseInt(hexColor[1] + hexColor[1], 16);
                b = parseInt(hexColor[2] + hexColor[2], 16);
            } else {
                r = parseInt(hexColor.substring(0, 2), 16);
                g = parseInt(hexColor.substring(2, 4), 16);
                b = parseInt(hexColor.substring(4, 6), 16);
            }
            
            // Calcula luminosidade usando a f√≥rmula YIQ
            // Esta f√≥rmula √© amplamente utilizada para determinar contraste
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            
            // Retorna true se a cor for escura (contrast < 128)
            return yiq < 128;
        }
        
        /**
         * Ajusta a cor do texto de todos os bot√µes com base na cor de fundo
         */
        function applyButtonContrast() {
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            
            if (!primaryColor) return;
            
            const needsWhiteText = isColorDark(primaryColor);
            const textColor = needsWhiteText ? '#ffffff' : '#1f2937'; // white ou gray-800
            
            console.log(`Cor prim√°ria: ${primaryColor} (${needsWhiteText ? 'escuro' : 'claro'}) - Texto: ${textColor}`);
            
            // 1. Bot√µes com estilo inline background-color (produtos, hist√≥rico)
            document.querySelectorAll('button[style*="background-color"]').forEach(btn => {
                const bgColor = btn.style.backgroundColor;
                // Verifica se o bot√£o usa a cor prim√°ria
                if (bgColor && (bgColor.includes('var(--primary)') || bgColor.includes(primaryColor) || bgColor.includes('rgb'))) {
                    // Remove classes de texto que possam conflitar
                    btn.classList.remove('text-white');
                    btn.style.color = textColor;
                    
                    // Remove text-white de elementos filhos
                    btn.querySelectorAll('.text-white').forEach(el => {
                        el.classList.remove('text-white');
                        el.style.color = textColor;
                    });
                    
                    // Remove text-white de spans internos
                    btn.querySelectorAll('span').forEach(span => {
                        if (span.classList.contains('text-white')) {
                            span.classList.remove('text-white');
                            span.style.color = textColor;
                        }
                        span.style.color = textColor;
                    });
                    
                    // Ajusta √≠cones
                    btn.querySelectorAll('i').forEach(icon => {
                        icon.style.color = textColor;
                    });
                }
            });
            
            // 2. Footer cart - elemento principal
            const footerCart = document.getElementById('footer-cart');
            if (footerCart) {
                footerCart.style.color = textColor;
                
                // Remove text-white de todos os elementos do footer
                footerCart.querySelectorAll('.text-white').forEach(el => {
                    el.classList.remove('text-white');
                    el.style.color = textColor;
                });
                
                // √çcone do carrinho (exceto o badge de contador)
                const cartIcon = footerCart.querySelector('.fa-shopping-bag');
                if (cartIcon) cartIcon.style.color = textColor;
                
                // Texto do total estimado
                const cartText = footerCart.querySelector('#cart-total-preview');
                if (cartText) cartText.style.color = textColor;
                
                // Labels com opacidade
                footerCart.querySelectorAll('span[class*="text-white"]').forEach(span => {
                    span.style.color = needsWhiteText ? 'rgba(255,255,255,0.8)' : 'rgba(31,41,55,0.8)';
                });
                
                // Bot√£o "Ver Sacola"
                const verSacolaBtn = footerCart.querySelector('.bg-white');
                if (verSacolaBtn) {
                    verSacolaBtn.style.backgroundColor = textColor;
                    verSacolaBtn.style.color = needsWhiteText ? '#1f2937' : '#ffffff';
                    // Remove classes de texto hardcoded
                    verSacolaBtn.classList.remove('text-white', 'text-orange-600');
                }
            }
            
            // 3. Bot√µes de entrega/retirada ativos
            const deliveryActiveBtn = document.getElementById('btn-delivery');
            if (deliveryActiveBtn && deliveryActiveBtn.classList.contains('bg-white')) {
                deliveryActiveBtn.style.color = primaryColor;
            }
            
            const pickupActiveBtn = document.getElementById('btn-pickup');
            if (pickupActiveBtn && pickupActiveBtn.classList.contains('bg-white')) {
                pickupActiveBtn.style.color = primaryColor;
            }
        }
        
        // Executar ap√≥s o DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Pequeno delay para garantir que as vari√°veis CSS foram carregadas
            setTimeout(applyButtonContrast, 100);
            
            // Adicionar MutationObserver para detectar novos elementos adicionados
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        applyButtonContrast();
                    }
                });
            });
            
            // Observar o body para mudan√ßas
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
        
        // Reaplicar quando o modal do carrinho abrir (pois pode ter elementos din√¢micos)
        window.openCart = function() { 
            document.getElementById("cart-modal").classList.remove("hidden"); 
            document.body.classList.add("overflow-hidden"); 
            window.renderCartItems(); 
            document.getElementById("step-1-cart").classList.remove("hidden"); 
            document.getElementById("step-2-address").classList.add("hidden"); 
            document.getElementById("btn-finalize").classList.add("hidden"); 
            document.getElementById("btn-next-step").classList.remove("hidden"); 

            // Reaplicar contraste
            const isTable = window.TABLE_MODE !== null;
            const allowScheduling = {{ tenant.allow_scheduling|yesno:"true,false" }};
            const schedulingContainer = document.querySelector('#is_scheduled').closest('.bg-orange-50');

            if (isTable || !allowScheduling) {
                schedulingContainer.classList.add('hidden');
                document.getElementById('is_scheduled').checked = false;
                document.getElementById('scheduling-fields').classList.add('hidden');
            } else {
                schedulingContainer.classList.remove('hidden');
            }
            
            // Atualiza estado dos bot√µes de entrega/retirada ao abrir carrinho
            updateDeliveryButtons();
            
            // Reaplicar contraste
            setTimeout(applyButtonContrast, 100);
        };
        
        // ============================================
        // L√ìGICA DE MESA (QR CODE) - DEVE VIR ANTES DE QUALQUER USO
        // ============================================

        // Extrair n√∫mero da mesa da URL (ex: /loja/slug/mesa/5/)
        function getTableNumberFromUrl() {
            const path = window.location.pathname;
            // Regex para capturar o n√∫mero ap√≥s /mesa/
            const match = path.match(/\/mesa\/(\d+)/i);
            return match ? parseInt(match[1]) : null;
        }

        // Fun√ß√£o toggleDelivery local para uso imediato (antes do script.js carregar)
        window.TABLE_MODE = getTableNumberFromUrl();
        
        function setupTableMode() {
            if (!window.TABLE_MODE) return;

            window.TABLE_NUMBER = window.TABLE_MODE;
            
            const btnDelivery = document.getElementById('btn-delivery');
            const btnPickup = document.getElementById('btn-pickup');
            const addrCont = document.getElementById('address-container');
            const geoBtn = document.getElementById('btn-geo');
            const cepInput = document.getElementById('cep');
            const addressInput = document.getElementById('address');
            const numberInput = document.getElementById('number');
            const neighborhoodInput = document.getElementById('neighborhood');

            // Adicionar badge de mesa no header
            const statusContainer = document.getElementById('status-loja-container');
            if (statusContainer) {
                const tableBadge = document.createElement('div');
                tableBadge.className = 'flex items-center gap-2 px-3 py-1 bg-orange-500/90 rounded-full text-white font-bold text-xs shadow-lg animate-pulse ml-2';
                tableBadge.innerHTML = '<i class="fas fa-chair"></i> MESA ' + window.TABLE_MODE;
                statusContainer.parentNode.insertBefore(tableBadge, statusContainer.nextSibling);
            }

            // Atualizar texto do rodap√© para indicar mesa
            const footerCart = document.getElementById('footer-cart');
            if (footerCart) {
                const mesaBadge = document.createElement('div');
                mesaBadge.className = 'bg-white/20 px-3 py-1 rounded-full text-white text-xs font-bold';
                mesaBadge.innerHTML = '<i class="fas fa-chair mr-1"></i>Mesa ' + window.TABLE_MODE;
                footerCart.querySelector('.flex').insertBefore(mesaBadge, footerCart.querySelector('.flex').lastElementChild);
            }

            // Esconder completamente campos de endere√ßo e telefone para modo mesa
            if (addrCont) addrCont.style.display = 'none';
            if (geoBtn) geoBtn.style.display = 'none';
            if (cepInput) cepInput.style.display = 'none';
            if (addressInput) addressInput.style.display = 'none';
            if (numberInput) numberInput.style.display = 'none';
            if (neighborhoodInput) neighborhoodInput.style.display = 'none';
            
            // Ocultar campo de telefone quando pedido √© na mesa
            const phoneInput = document.getElementById('client-phone');
            if (phoneInput) phoneInput.style.display = 'none';

            // Desabilitar visualmente o bot√£o de entrega
            if (btnDelivery) {
                btnDelivery.classList.remove('bg-white', 'text-orange-600');
                btnDelivery.classList.add('text-gray-300', 'cursor-not-allowed', 'bg-gray-50');
                btnDelivery.onclick = null;
            }

            // Ativar visualmente o bot√£o de retirada
            if (btnPickup) {
                btnPickup.classList.add('bg-white', 'text-orange-600');
                btnPickup.classList.remove('text-gray-500');
                // Atualizar texto para indicar mesa
                btnPickup.innerHTML = '<i class="fas fa-utensils mr-1"></i> MESA ' + window.TABLE_MODE;
            }

            // Log para debug
            console.log('Cliente na mesa:', window.TABLE_MODE);
        }

        // Aplicar modo mesa ANTES de qualquer outra coisa
        document.addEventListener('DOMContentLoaded', function() {
            setupTableMode();
        });

        // Configura√ß√µes Globais da Loja vindas do Backend
        window.STORE_CONFIG = {
            storeName: "{{ tenant.name|escapejs }}",
            phone: "{{ tenant.phone_whatsapp }}",
            pixKey: "{{ tenant.pix_key|default:'' }}",
            pixName: "{{ tenant.pix_name|default:'' }}",
            pixCity: "{{ tenant.pix_city|default:'' }}",
            storeIsOpen: {{ store_is_open|yesno:"true,false" }},
            schedule: JSON.parse('{{ schedule_json|safe }}'),
            deliveryFees: JSON.parse('{{ delivery_fees_json|safe }}'),
            isOpen: true,
            // Configura√ß√µes de Tempo
            deliveryTime: {{ tenant.delivery_time|default:45 }},
            pickupTime: {{ tenant.pickup_time|default:25 }}
        };

        // Dados completos dos produtos (para o modal funcionar sem ir no banco)
        window.PRODUCTS_DATA = {};
        
        {% for category in categories %}
            {% for product in category.products.all %}
            window.PRODUCTS_DATA['{{ product.id }}'] = {
                id: '{{ product.id }}',
                name: '{{ product.name|escapejs }}',
                price: {{ product.price|stringformat:".2f" }},
                // Adiciona o pre√ßo original ao objeto JSON
                original_price: {% if product.original_price %}{{ product.original_price|stringformat:".2f" }}{% else %}null{% endif %},
                description: '{{ product.description|escapejs }}',
                image: '{% if product.image %}{{ product.image.url }}{% else %}data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect fill="%23fff7ed" width="200" height="200"/><circle cx="100" cy="90" r="40" fill="%23fed7aa" opacity="0.5"/><text x="100" y="100" font-family="FontAwesome" font-size="50" text-anchor="middle" fill="%23fdba74">Ôãß</text><text x="100" y="155" font-family="Arial" font-size="14" text-anchor="middle" fill="%23fb923c" font-weight="bold">SABOR</text></svg>{% endif %}',
                opcoes: [
                    {% for opt in product.options.all %}
                    {
                        title: "{{ opt.title }}",
                        type: "{{ opt.type }}",
                        required: {{ opt.required|yesno:"true,false" }},
                        max: {{ opt.max_quantity }},
                        items: [
                            {% for item in opt.items.all %}
                            { name: "{{ item.name }}", price: {{ item.price|stringformat:".2f" }} },
                            {% endfor %}
                        ]
                    },
                    {% endfor %}
                ]
            };
            {% endfor %}
        {% endfor %}

        // ============================================
        // FUN√á√ÉO DE FILTRAGEM DE CATEGORIAS
        // ============================================
        
        // Fun√ß√£o para filtrar por categoria com scroll suave
        window.filterCategory = function(categoryId, buttonElement) {
            // Remove a classe active-category de todos os bot√µes
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active-category', 'bg-gray-900', 'text-white', 'dark:bg-white', 'dark:text-gray-900');
                btn.classList.add('bg-white', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-300', 'border', 'border-gray-200', 'dark:border-gray-700');
            });

            // Adiciona a classe active-category ao bot√£o clicado
            if (buttonElement) {
                buttonElement.classList.add('active-category', 'bg-gray-900', 'text-white', 'dark:bg-white', 'dark:text-gray-900');
                buttonElement.classList.remove('bg-white', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-300', 'border', 'border-gray-200', 'dark:border-gray-700');
            }

            // Se for "all", mostra todos os produtos e rola para o topo
            if (categoryId === 'all') {
                document.querySelectorAll('.category-section').forEach(section => {
                    section.style.display = '';
                });
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                return;
            }

            // Esconde todas as se√ß√µes primeiro
            document.querySelectorAll('.category-section').forEach(section => {
                section.style.display = 'none';
            });

            // Mostra apenas a categoria selecionada
            const targetSection = document.getElementById(categoryId);
            if (targetSection) {
                targetSection.style.display = '';
                
                // Scroll suave at√© a se√ß√£o
                const navHeight = document.getElementById('category-nav').offsetHeight;
                const targetPosition = targetSection.offsetTop - navHeight - 20;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            }
        };

        // Inicializar estado ativo na carga da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° uma categoria na URL (√¢ncora)
            const hash = window.location.hash;
            if (hash && hash.startsWith('#cat-')) {
                const categoryId = hash.substring(1); // Remove o #
                const button = document.querySelector(`button[onclick*="${categoryId}"]`);
                if (button) {
                    // Pequeno delay para garantir que tudo carregou
                    setTimeout(() => {
                        filterCategory(categoryId, button);
                    }, 100);
                }
            }
        });

        // Atualizar bot√£o ativo durante scroll (Intersection Observer)
        document.addEventListener('DOMContentLoaded', function() {
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -80% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const categoryId = entry.target.id;
                        const button = document.querySelector(`button[onclick*="${categoryId}"]`);
                        if (button && !button.classList.contains('active-category')) {
                            // Remove active de todos
                            document.querySelectorAll('.category-btn').forEach(btn => {
                                btn.classList.remove('active-category', 'bg-gray-900', 'text-white', 'dark:bg-white', 'dark:text-gray-900');
                                btn.classList.add('bg-white', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-300', 'border', 'border-gray-200', 'dark:border-gray-700');
                            });
                            // Adiciona active ao bot√£o vis√≠vel
                            button.classList.add('active-category', 'bg-gray-900', 'text-white', 'dark:bg-white', 'dark:text-gray-900');
                            button.classList.remove('bg-white', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-300', 'border', 'border-gray-200', 'dark:border-gray-700');
                        }
                    }
                });
            }, observerOptions);

            // Observar todas as se√ß√µes de categoria
            document.querySelectorAll('.category-section').forEach(section => {
                observer.observe(section);
            });
        });

        // Registrar Service Worker UNIFICADO (Cache + Push)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker unificado registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Erro ao registrar Service Worker:', error);
                    });
            });
        }

        // ============================================
        // TOAST DE INSTALA√á√ÉO DO PWA
        // ============================================
        let deferredPrompt;
        let pwaToastShown = false;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra o toast apenas se ainda n√£o foi mostrado
            if (!pwaToastShown) {
                showInstallToast();
                pwaToastShown = true;
            }
        });
        
        function showInstallToast() {
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#ea580c';
            
            // Criar o elemento do toast se n√£o existir
            if (!document.getElementById('pwa-install-toast')) {
                const toastContainer = document.createElement('div');
                toastContainer.id = 'pwa-install-toast';
                toastContainer.innerHTML = `
                    <div style="
                        position: fixed;
                        bottom: 80px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
                        color: white;
                        padding: 16px 20px;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        z-index: 9999;
                        max-width: 90%;
                        width: 380px;
                        animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                        font-family: 'Inter', sans-serif;
                    " onmouseover="this.style.transform='translateX(-50%) scale(1.02)'" onmouseout="this.style.transform='translateX(-50%) scale(1)'">
                        <div style="
                            width: 48px;
                            height: 48px;
                            background: ${primaryColor};
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            flex-shrink: 0;
                        ">
                            <i class="fas fa-mobile-alt" style="font-size: 24px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-weight: 600; font-size: 14px; line-height: 1.4;">Pe√ßa no nosso aplicativo</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.8;">Mais r√°pido e pr√°tico!</p>
                        </div>
                        <button onclick="installPWA()" style="
                            background: ${primaryColor};
                            border: none;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 10px;
                            font-weight: 600;
                            font-size: 12px;
                            cursor: pointer;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">
                            INSTALAR
                        </button>
                        <button onclick="closeInstallToast()" style="
                            background: transparent;
                            border: none;
                            color: rgba(255,255,255,0.6);
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='white'" onmouseout="this.style.background='transparent';this.style.color='rgba(255,255,255,0.6)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <style>
                        @keyframes slideUpFade {
                            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                            to { opacity: 1; transform: translateX(-50%) translateY(0); }
                        }
                        @keyframes fadeOut {
                            from { opacity: 1; transform: translateX(-50%) translateY(0); }
                            to { opacity: 0; transform: translateX(-50%) translateY(20px); }
                        }
                    </style>
                `;
                document.body.appendChild(toastContainer);
            }
        }
        
        function closeInstallToast() {
            const toast = document.getElementById('pwa-install-toast');
            if (toast) {
                toast.querySelector('div').style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }
        
        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Resultado da instala√ß√£o:', outcome);
                
                if (outcome === 'accepted') {
                    closeInstallToast();
                }
                
                deferredPrompt = null;
            }
        };
        
        // Detectar quando a aplica√ß√£o √© instalada
        window.addEventListener('appinstalled', () => {
            console.log('PWA foi instalada com sucesso');
            closeInstallToast();
            deferredPrompt = null;
        });
        
        // ========================
        // FAVICON DIN√ÇMICO
        // ========================
        // Atualiza o favicon se houver uma logo salva no localStorage
        function updateFaviconFromLogo() {
            const savedLogo = localStorage.getItem('tenant_logo_url');
            if (savedLogo) {
                const favicon = document.getElementById('dynamic-favicon');
                const faviconShortcut = document.getElementById('dynamic-favicon-shortcut');
                const appleIcon = document.getElementById('dynamic-apple-icon');
                
                if (favicon) favicon.href = savedLogo;
                if (faviconShortcut) faviconShortcut.href = savedLogo;
                if (appleIcon) appleIcon.href = savedLogo;
            }
        }
        
        // Executar ao carregar
        updateFaviconFromLogo();
        
        // ========================
        // NOTIFICA√á√ïES PUSH
        // ========================
        
        // Fun√ß√£o para mostrar o toast de permiss√£o de notifica√ß√µes
        function showPushNotificationToast() {
            // N√£o mostrar se j√° foi recusado ou aceito antes
            const pushStatus = localStorage.getItem(`push_notification_status_${window.TENANT_SLUG}`);
            if (pushStatus === 'denied' || pushStatus === 'granted') return;
            
            // N√£o mostrar se n√£o suporta notifica√ß√µes
            if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
                return;
            }
            
            // Verificar se j√° estamos registrados
            if (localStorage.getItem(`push_subscribed_${window.TENANT_SLUG}`) === 'true') return;
            
            // Criar o toast
            const toastId = 'push-notification-toast';
            if (document.getElementById(toastId)) return;
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 140px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    padding: 20px;
                    border-radius: 16px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                    z-index: 9999;
                    max-width: 90%;
                    width: 320px;
                    animation: slideUpFade 0.4s ease-out;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    text-align: center;
                ">
                    <div style="
                        width: 56px;
                        height: 56px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, var(--primary, #ea580c), #f97316);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-bottom: 12px;
                    ">
                        <i class="fas fa-bell" style="color: white; font-size: 24px;"></i>
                    </div>
                    <p style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: #1f2937;">
                        Fique por dentro!
                    </p>
                    <p style="margin: 0 0 16px 0; font-size: 14px; color: #6b7280; line-height: 1.5;">
                        Deseja receber notifica√ß√µes sobre o status do seu pedido?
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                        <button id="push-accept-btn" style="
                            padding: 12px 20px;
                            background: linear-gradient(135deg, var(--primary, #ea580c), #f97316);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            width: 100%;
                        ">üîî Ativar Notifica√ß√µes</button>
                        <button id="push-deny-btn" style="
                            padding: 10px;
                            background: transparent;
                            color: #9ca3af;
                            border: none;
                            font-size: 13px;
                            cursor: pointer;
                            width: 100%;
                        ">Agora n√£o</button>
                    </div>
                    <button onclick="closePushToast()" style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: none;
                        border: none;
                        color: #d1d5db;
                        cursor: pointer;
                        padding: 6px;
                        border-radius: 50%;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#f3f4f6';this.style.color='#6b7280'" onmouseout="this.style.background='transparent';this.style.color='#d1d5db'">
                        <i class="fas fa-times" style="font-size: 14px;"></i>
                    </button>
                </div>
                <style>
                    @keyframes slideUpFade {
                        from { opacity: 0; transform: translateX(-50%) translateY(30px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; transform: translateX(-50%) translateY(0); }
                        to { opacity: 0; transform: translateX(-50%) translateY(30px); }
                    }
                </style>
            `;
            document.body.appendChild(toast);
            
            // Event listeners
            document.getElementById('push-accept-btn').addEventListener('click', requestPushPermission);
            document.getElementById('push-deny-btn').addEventListener('click', () => closePushToast());
        }
        
        function closePushToast() {
            const toast = document.getElementById('push-notification-toast');
            if (toast) {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }
        
        async function requestPushPermission() {
            closePushToast();
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    localStorage.setItem(`push_notification_status_${window.TENANT_SLUG}`, 'granted');
                    await registerServiceWorkerAndSubscribe();
                    Toastify({
                        text: "Notifica√ß√µes ativadas! Voc√™ ser√° avisado sobre o status do seu pedido.",
                        style: { background: "#10b981" },
                        duration: 5000
                    }).showToast();
                } else if (permission === 'denied') {
                    localStorage.setItem(`push_notification_status_${window.TENANT_SLUG}`, 'denied');
                }
            } catch (error) {
                console.error('Erro ao solicitar permiss√£o:', error);
            }
        }
        
        async function registerServiceWorkerAndSubscribe() {
            try {
                console.log('[PUSH] 1. Iniciando registro de Service Worker e subscription...');
                
                // Registrar Service Worker
                console.log('[PUSH] 2. Registrando Service Worker...');
                const registration = await navigator.serviceWorker.register('/static/sw.js')
                    .catch((err) => {
                        console.error('[PUSH] Erro no registro do SW:', err);
                        return null;
                    });
                
                if (!registration) {
                    console.error('[PUSH] ERRO: Registration retornou null');
                    return;
                }
                
                console.log('[PUSH] 3. Service Worker registrado com sucesso');
                console.log('[PUSH] Registration state:', registration.active ? 'active' : (registration.installing ? 'installing' : 'waiting'));
                
                // Fun√ß√£o utilit√°ria com timeout para aguardar.ready
                const waitForReady = (registration) => {
                    return new Promise((resolve, reject) => {
                        // Timeout de 10 segundos
                        const timeout = setTimeout(() => {
                            console.warn('[PUSH] Timeout aguardando ready, usando registration diretamente');
                            resolve(registration); // Resolve com o registration como fallback
                        }, 10000);
                        
                        // Se j√° tem um SW ativo, resolver imediatamente
                        if (registration.active) {
                            clearTimeout(timeout);
                            console.log('[PUSH] 4. SW j√° est√° ativo');
                            resolve(registration);
                            return;
                        }
                        
                        // Aguardar mudan√ßa de estado
                        const stateListener = (worker) => {
                            console.log('[PUSH] SW state changed to:', worker.state);
                            if (worker.state === 'activated') {
                                clearTimeout(timeout);
                                registration.removeEventListener('updatefound', stateListener);
                                console.log('[PUSH] 4. SW ativado e pronto');
                                resolve(registration);
                            }
                        };
                        
                        registration.addEventListener('updatefound', stateListener);
                        
                        // Se h√° um installing, aguardar
                        if (registration.installing) {
                            registration.installing.addEventListener('statechange', stateListener);
                        }
                    });
                };
                
                // Aguardar o SW estar pronto
                console.log('[PUSH] 4. Aguardando Service Worker estar pronto...');
                const readyRegistration = await waitForReady(registration);
                console.log('[PUSH] 5. Pronto para continuar, registration:', !!readyRegistration);
                
                // VAPID Public Key - DEVE ser a mesma do settings.py
                const vapidPublicKey = "{{ vapid_public_key }}";
                console.log('[PUSH] 6. Usando VAPID key configurada');
                
                // Verificar se j√° est√° inscrito
                console.log('[PUSH] 7. Verificando subscription existente...');
                let subscription = await readyRegistration.pushManager.getSubscription()
                    .catch((err) => {
                        console.error('[PUSH] ERRO ao getSubscription:', err);
                        return null;
                    });
                
                console.log('[PUSH] 8. Subscription atual:', subscription ? 'encontrada' : 'null');
                
                if (!subscription) {
                    console.log('[PUSH] 9. Criando nova subscription...');
                    try {
                        subscription = await readyRegistration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                        });
                        console.log('[PUSH] 10. Nova subscription criada com sucesso');
                    } catch (subscribeErr) {
                        console.error('[PUSH] ERRO ao criar subscription:', subscribeErr);
                        console.error('[PUSH] Detalhes do erro:', subscribeErr.message);
                        // Verificar se √© erro de permiss√£o
                        if (subscribeErr.name === 'NotAllowedError') {
                            console.error('[PUSH] O usu√°rio bloqueou as notifica√ß√µes ou o site n√£o tem permiss√£o');
                        }
                        return;
                    }
                    
                    // Converter subscription para JSON
                    const subscriptionJson = subscription.toJSON();
                    console.log('[PUSH] 11. Subscription JSON gerado');
                    console.log('[PUSH] Endpoint:', subscriptionJson.endpoint ? 'OK' : 'FALTANDO');
                    console.log('[PUSH] Keys:', subscriptionJson.keys ? 'OK' : 'FALTANDO');
                    
                    // Enviar subscription para o servidor
                    const apiUrl = '/' + window.TENANT_SLUG + '/api/push/subscribe/';
                    console.log('[PUSH] 12. Enviando para:', apiUrl);
                    console.log('[PUSH] CSRF Token:', window.CSRF_TOKEN);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        },
                        body: JSON.stringify({ subscription: subscriptionJson })
                    });
                    
                    console.log('[PUSH] 13. Response status:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[PUSH] ERRO na response:', errorText);
                        return;
                    }
                    
                    const responseData = await response.json();
                    console.log('[PUSH] 14. Response data:', responseData);
                    
                    if (responseData.status === 'success') {
                        localStorage.setItem(`push_subscribed_${window.TENANT_SLUG}`, 'true');
                        console.log('[PUSH] ‚úÖ Subscription salva com sucesso para ' + window.TENANT_SLUG);
                    } else {
                        console.error('[PUSH] ERRO: Backend retornou status de erro:', responseData);
                    }
                } else {
                    console.log('[PUSH] Usu√°rio j√° est√° inscrito, verificando se precisa reenviar...');
                    // Verificar se a subscription ainda √© v√°lida
                    const subscriptionJson = subscription.toJSON();
                    const apiUrl = '/' + window.TENANT_SLUG + '/api/push/subscribe/';
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        },
                        body: JSON.stringify({ subscription: subscriptionJson })
                    });
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('[PUSH] Subscription verificada/atualizada:', responseData);
                        localStorage.setItem(`push_subscribed_${window.TENANT_SLUG}`, 'true');
                    }
                }
            } catch (error) {
                console.error('[PUSH] ‚ùå Erro geral ao registrar para notifica√ß√µes:', error);
                console.error('[PUSH] Stack trace:', error.stack);
            }
        }
        
        // Fun√ß√£o utilit√°ria para converter VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
        }
        
        // Mostrar toast ap√≥s 3 segundos
        setTimeout(showPushNotificationToast, 3000);
    </script>

    <!-- Rodap√© com Links Legais -->
    <footer class="mt-auto py-8 px-4 text-center border-t border-gray-100 bg-white/50 backdrop-blur-sm">
        <div class="max-w-md mx-auto">
            <p class="text-[10px] text-gray-400 font-medium uppercase tracking-wider mb-2">
                Tecnologia
            </p>
            <div class="flex items-center justify-center gap-2 mb-4 opacity-70 grayscale hover:grayscale-0 transition duration-300">
                <span class="font-bold text-gray-600 text-sm">RM <span class="text-orange-600"><a href="https://www.rmpedidos.online/" target="_blank">Pedidos</a></span></span>
            </div>

            <a href="{% url 'custom_login' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full text-xs font-bold transition duration-200">
                <i class="fas fa-user-lock"></i>
                Sou o Lojista (Entrar)
            </a>
            
            <p class="text-[10px] text-orange-700 mt-4">
                &copy; {% now "Y" %} {{ tenant.name }} - Todos os direitos reservados.
            </p>
        </div>
    </footer>

    <script src="{% static 'script.js' %}?v=2"></script>

</body>
</html>